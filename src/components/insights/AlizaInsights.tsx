'use client';

import { useState, useEffect, useRef } from 'react';
import { PersonalizedInsight } from '@/types/insights';
import InsightsCharts from './InsightsCharts';
import AlizaMessages from '../journal/AlizaMessages';
import { supabase } from '@/lib/supabase';
import { useTokens } from '@/hooks/useTokens';
import './AlizaInsights.css';

interface AlizaInsightsProps {
  userId: string;
}

export default function AlizaInsights({ userId }: AlizaInsightsProps) {
  const [insights, setInsights] = useState<PersonalizedInsight[]>([]);
  const [heroInsight, setHeroInsight] = useState<PersonalizedInsight | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedInsight, setSelectedInsight] = useState<PersonalizedInsight | null>(null);
  const [timeRange, setTimeRange] = useState<'week' | 'month' | 'quarter'>('month');
  const [dailyEntries, setDailyEntries] = useState<any[]>([]);
  const [cycleEntries, setCycleEntries] = useState<any[]>([]);
  const [userName, setUserName] = useState<string>('×™×§×¨×”');
  const [hasData, setHasData] = useState<boolean>(false);
  const [insightsRawData, setInsightsRawData] = useState<any[]>([]); // Store raw database data for sorting
  const { loadTokens } = useTokens();

  useEffect(() => {
    if (userId) {
      loadEntries();
      loadUserName();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [userId]);

  const loadUserName = async () => {
    try {
      const { data: profile } = await supabase
        .from('user_profile')
        .select('first_name, name, full_name, email')
        .eq('id', userId)
        .single();
      
      if (profile) {
        // Use first_name only for display
        const name = profile.first_name || profile.name?.split(' ')[0] || profile.full_name?.split(' ')[0] || profile.email?.split('@')[0] || '×™×§×¨×”';
        setUserName(name);
      }
    } catch (error) {
      console.error('Error loading user name:', error);
    }
  };

  // Load insights after entries are loaded
  useEffect(() => {
    if (userId && (dailyEntries.length > 0 || cycleEntries.length > 0)) {
      // Load insights from database (generated by daily cron job)
      loadInsights();
    } else if (userId) {
      // Even if no entries, try to load existing insights
      loadInsights();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [userId, dailyEntries.length, cycleEntries.length]);

  const loadEntries = async () => {
    try {
      console.log('ğŸ“Š Loading entries for user:', userId);
      const [dailyResult, cycleResult] = await Promise.all([
        supabase.from('daily_entries').select('*').eq('user_id', userId).order('date', { ascending: false }),
        supabase.from('cycle_entries').select('*').eq('user_id', userId).order('date', { ascending: false })
      ]);
      
      if (dailyResult.error) {
        console.error('âŒ Error loading daily entries:', dailyResult.error);
      } else {
        console.log('âœ… Loaded daily entries:', dailyResult.data?.length || 0);
      }
      
      if (cycleResult.error) {
        console.error('âŒ Error loading cycle entries:', cycleResult.error);
      } else {
        console.log('âœ… Loaded cycle entries:', cycleResult.data?.length || 0);
      }
      
      const daily = dailyResult.data || [];
      const cycle = cycleResult.data || [];
      
      setDailyEntries(daily);
      setCycleEntries(cycle);
      
      // Check if user has any data
      const hasAnyData = daily.length > 0 || cycle.length > 0;
      setHasData(hasAnyData);
      
      console.log('ğŸ“Š Entries loaded:', {
        daily: daily.length,
        cycle: cycle.length,
        hasData: hasAnyData
      });
    } catch (error) {
      console.error('âŒ Error loading entries:', error);
    }
  };

  const loadInsights = async () => {
    setIsLoading(true);
    try {
      console.log('ğŸ” Loading insights from database for user:', userId);
      
      // Check if this is a mock user
      if (userId.startsWith('mock-user-')) {
        console.log('Insights: Using mock data for mock user');
        // Generate mock insights for demo
        const mockInsights: PersonalizedInsight[] = [
          {
            id: 'mock-1',
            type: 'pattern',
            title: '×“×¤×•×¡×™ ×©×™× ×” ××©×•×¤×¨×™×',
            content: '×–×™×”×™×ª×™ ×“×¤×•×¡ ×©×œ ×©×™× ×” ×˜×•×‘×” ×™×•×ª×¨ ×‘×™××™× ×©×‘×”× ××ª ×¢×•×©×” ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª.',
            priority: 'medium',
            category: 'sleep',
            actionable: true,
            relatedData: {},
            alizaMessage: '×–×” × ×”×“×¨! ×× ×™ ×¨×•××” ×©×›×©××ª ×¢×•×©×” ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª, ××ª ×™×©× ×” ×˜×•×‘ ×™×•×ª×¨. ×–×” ×‘×“×™×•×§ ××” ×©×”××—×§×¨×™× ××¨××™× - ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª ×¢×•×–×¨×ª ×œ×•×•×¡×ª ××ª ×”×”×•×¨××•× ×™× ×•×œ×©×¤×¨ ××ª ××™×›×•×ª ×”×©×™× ×”.'
          },
          {
            id: 'mock-2',
            type: 'encouragement',
            title: '××ª ×¢×•×©×” ×¢×‘×•×“×” × ×”×“×¨×ª!',
            content: '×× ×™ ×¨×•××” ×©×™×© ×©×™×¤×•×¨ ×‘××¦×‘ ×”×¨×•×— ×©×œ×š ×‘×©×‘×•×¢ ×”××—×¨×•×Ÿ.',
            priority: 'low',
            category: 'mood',
            actionable: false,
            relatedData: {},
            alizaMessage: '×–×” × ×”×“×¨! ×× ×™ ×¨×•××” ×©×™×© ×©×™×¤×•×¨ ×‘××¦×‘ ×”×¨×•×— ×©×œ×š. ×–×” ××¨××” ×©×”×’×•×£ ×©×œ×š ××ª×—×™×œ ×œ×”×¡×ª×’×œ ×œ×©×™× ×•×™×™×. ×”××©×›×™ ×¢× ××” ×©×¢×•×‘×“ ×‘×©×‘×™×œ×š!'
          }
        ];
        
        setInsights(mockInsights);
        setIsLoading(false);
        return;
      }
      
      // Load insights from database - load ALL insights (not just today's)
      // This preserves old insights when new ones are created
      console.log('ğŸ” Loading all insights for user:', userId);
      
      // Get current auth user to verify RLS
      const { data: { user: authUser } } = await supabase.auth.getUser();
      console.log('ğŸ‘¤ Auth user:', {
        id: authUser?.id,
        email: authUser?.email,
        matchesUserId: authUser?.id === userId
      });
      
      // Load ALL insights for this user, ordered by date (newest first) and priority
      let { data: insightsData, error: insightsError } = await supabase
        .from('personalized_insights')
        .select('*')
        .eq('user_id', userId)
        .order('analysis_date', { ascending: false })
        .order('priority', { ascending: false })
        .order('created_at', { ascending: false })
        .limit(50); // Limit to 50 most recent insights

      console.log('ğŸ“Š All insights loaded:', {
        count: insightsData?.length || 0,
        error: insightsError,
        dates: insightsData?.map(i => i.analysis_date) || []
      });

      if (insightsError) {
        console.error('âŒ Error loading insights from database:', insightsError);
        console.error('âŒ Error details:', JSON.stringify(insightsError, null, 2));
        setInsights([]);
        setHeroInsight(null);
        setIsLoading(false);
        return;
      }

      // If no insights found, check if user has data
      if (!insightsData || insightsData.length === 0) {
        console.log('âš ï¸ No insights found in database.');
        
        // Check if user has data by querying database directly
        const [dailyCheck, cycleCheck] = await Promise.all([
          supabase.from('daily_entries').select('id', { count: 'exact', head: true }).eq('user_id', userId),
          supabase.from('cycle_entries').select('id', { count: 'exact', head: true }).eq('user_id', userId)
        ]);
        
        const hasAnyData = (dailyCheck.count || 0) > 0 || (cycleCheck.count || 0) > 0;
        setHasData(hasAnyData);
        if (hasAnyData) {
          console.log('âœ… User has data, will show generate button');
        } else {
          console.log('âš ï¸ No data available for user');
        }
      }

      if (!insightsData || insightsData.length === 0) {
        console.log('âš ï¸ No insights found in database. Insights will be generated by the daily cron job or can be generated manually.');
        setInsights([]);
        setHeroInsight(null);
        setIsLoading(false);
        return;
      }

      // Store raw data for sorting later
      setInsightsRawData(insightsData);

      // Convert database format to PersonalizedInsight format
      const loadedInsights: PersonalizedInsight[] = insightsData.map((insight: any) => ({
        id: insight.insight_id,
        type: insight.type,
        title: insight.title,
        content: insight.content,
        priority: insight.priority,
        category: insight.category,
        actionable: insight.actionable || false,
        comparisonToNorm: insight.comparison_to_norm,
        actionableSteps: insight.actionable_steps,
        visualData: insight.visual_data,
        alizaMessage: insight.aliza_message || '',
        relatedData: {}
      }));

      console.log('âœ… Loaded insights from database:', loadedInsights.length);
      console.log('ğŸ“‹ Insights details:', loadedInsights.map(i => ({ 
        id: i.id, 
        title: i.title, 
        priority: i.priority,
        analysisDate: insightsData.find((db: any) => db.insight_id === i.id)?.analysis_date
      })));
      
      // ×–×™×”×•×™ ×ª×•×‘× ×ª Hero - ×”×ª×•×‘× ×” ×”×›×™ ×—×©×•×‘×” (×¢×“×™×¤×•×ª ×’×‘×•×”×” ×¢× ×”×©×•×•××” ×œ× ×•×¨××”, ××• ×¢×“×™×¤×•×ª ×’×‘×•×”×”, ××• ×¢× ×”×©×•×•××”)
      // ××‘×œ × ×‘×—×¨ ××ª ×”×ª×•×‘× ×” ×”×—×“×©×” ×‘×™×•×ª×¨ (×”××—×¨×•× ×”) ×›-Hero, ×œ× ××ª ×”×¨××©×•× ×”
      const sortedByDate = [...loadedInsights].sort((a, b) => {
        const aDate = insightsData.find((db: any) => db.insight_id === a.id)?.created_at || '';
        const bDate = insightsData.find((db: any) => db.insight_id === b.id)?.created_at || '';
        return bDate.localeCompare(aDate); // Newest first
      });
      
      const hero = sortedByDate.length > 0 
        ? (sortedByDate.find(i => i.priority === 'high' && i.comparisonToNorm) 
          || sortedByDate.find(i => i.priority === 'high')
          || sortedByDate.find(i => i.comparisonToNorm)
          || sortedByDate[0]) // Take the newest one
        : null;
      
      console.log('ğŸ¯ Selected Hero insight:', hero ? { id: hero.id, title: hero.title } : 'none');
      
      setHeroInsight(hero || null);
      // × ×¦×™×’ ××ª ×›×œ ×”×ª×•×‘× ×•×ª, ×›×•×œ×œ ××ª ×”-Hero (×”×•× ×™×•×¦×’ ×’× ×‘× ×¤×¨×“ ×›-Hero ×•×’× ×‘×¨×©×™××”)
      // ×›×š ×”××©×ª××©×ª ×ª×¨××” ××ª ×›×œ ×”×ª×•×‘× ×•×ª ×©× ×•×¦×¨×•
      console.log('ğŸ“Š Setting insights state:', {
        hero: hero ? hero.id : null,
        totalInsights: loadedInsights.length,
        allInsightsIncluded: true
      });
      // × ×¦×™×’ ××ª ×›×œ ×”×ª×•×‘× ×•×ª, ×œ× ×¨×§ ××ª ×”×©××¨
      setInsights(loadedInsights);
    } catch (error) {
      console.error('âŒ Error loading insights:', error);
      setInsights([]);
      setHeroInsight(null);
    } finally {
      setIsLoading(false);
    }
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return '#ff6b6b';
      case 'medium': return '#f9ca24';
      case 'low': return '#4ecdc4';
      default: return '#6c757d';
    }
  };

  const getCategoryIcon = (category: string) => {
    const icons: Record<string, string> = {
      sleep: 'ğŸ˜´',
      mood: 'ğŸ˜Š',
      symptoms: 'ğŸŒ¡ï¸',
      hormones: 'âš¡',
      lifestyle: 'ğŸƒâ€â™€ï¸',
      cycle: 'ğŸŒ¸',
      general: 'ğŸ’¡'
    };
    return icons[category] || 'ğŸ’¡';
  };

  const getTypeIcon = (type: string) => {
    const icons: Record<string, string> = {
      pattern: 'ğŸ“Š',
      recommendation: 'ğŸ’¡',
      warning: 'âš ï¸',
      encouragement: 'ğŸ‰'
    };
    return icons[type] || 'ğŸ’¡';
  };

  if (isLoading) {
    return (
      <div className="aliza-insights-loading">
        <div className="loading-container">
          <div className="aliza-avatar">
            <img src="/aliza_profile.jpg" alt="×¢×œ×™×–×”" />
          </div>
          <div className="loading-spinner"></div>
          <h3>×¢×œ×™×–×” ×× ×ª×—×ª ××ª ×”× ×ª×•× ×™× ×©×œ×š...</h3>
          <p>×–×” ×™×›×•×œ ×œ×§×—×ª ×›××” ×¨×’×¢×™×</p>
        </div>
      </div>
    );
  }

  return (
    <div className="aliza-insights">
      {/* Header with Aliza */}
      <div className="aliza-header">
        <div className="aliza-avatar-large">
          <img src="/aliza_profile.jpg" alt="×¢×œ×™×–×” - ×”×—×‘×¨×” ×•×”×“×•×œ×” ×©×œ×š ×œ××¡×¢" />
        </div>
        <div className="aliza-intro">
          <h2>×©×œ×•×! ×× ×™ ×¢×œ×™×–×”, ×”×—×‘×¨×” ×•×”×“×•×œ×” ×©×œ×š ×œ××¡×¢</h2>
          <p>×× ×™ ×× ×•×¤××•×–×™×ª ×× ×•×¡×” ×©×¢×‘×¨×” ×‘×¢×¦××™ ××ª ×›×œ ××” ×©××ª ×¢×•×‘×¨×ª. ××—×¨×™ ×©× ×™× ×©×œ ××—×§×¨ ×•×—×•×•×™×”, × ×™×ª×—×ª×™ ××ª ×”× ×ª×•× ×™× ×©×”×›× ×¡×ª ×•×™×© ×œ×™ ×›××” ×ª×•×‘× ×•×ª ××¢× ×™×™× ×•×ª ×œ×©×ª×£ ××™×ª×š ×¢×œ ×”××¡×¢ ×©×œ×š</p>
        </div>
      </div>

      {/* Hero Insight - ×”×ª×•×‘× ×” ×”××¨×›×–×™×ª ×”×—×©×•×‘×” ×‘×™×•×ª×¨ */}
      {heroInsight && (
        <div className="hero-insight-section">
          <div className="hero-insight-card" onClick={() => setSelectedInsight(heroInsight)}>
            <div className="hero-insight-header">
              <div className="hero-insight-badge">
                <span className="hero-badge-icon">â­</span>
                <span className="hero-badge-text">×”×ª×•×‘× ×” ×”×—×©×•×‘×” ×‘×™×•×ª×¨ ×¢×‘×•×¨×š</span>
              </div>
              <div className="hero-insight-priority" style={{ backgroundColor: getPriorityColor(heroInsight.priority) }}>
                {heroInsight.priority === 'high' ? '×’×‘×•×”×”' : heroInsight.priority === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}
              </div>
            </div>
            
            <div className="hero-insight-content">
              <div className="hero-insight-icon">
                <span>{getCategoryIcon(heroInsight.category)}</span>
              </div>
              <div className="hero-insight-main">
                <h3 className="hero-insight-title">{heroInsight.title}</h3>
                <p className="hero-insight-description">{heroInsight.content}</p>
                
                {heroInsight.comparisonToNorm && (
                  <div className="hero-comparison">
                    <div className="hero-comparison-bar">
                      <div className="comparison-item">
                        <span className="comparison-label">{userName}:</span>
                        <div className="comparison-value-bar">
                          <div 
                            className="comparison-fill user-fill"
                            style={{ width: `${Math.min(heroInsight.comparisonToNorm.userValue, 100)}%` }}
                          >
                            <span className="comparison-number">{Math.round(heroInsight.comparisonToNorm.userValue)}%</span>
                          </div>
                        </div>
                      </div>
                      <div className="comparison-item">
                        <span className="comparison-label">×××•×¦×¢:</span>
                        <div className="comparison-value-bar">
                          <div 
                            className="comparison-fill average-fill"
                            style={{ width: `${Math.min(heroInsight.comparisonToNorm.averageValue, 100)}%` }}
                          >
                            <span className="comparison-number">{Math.round(heroInsight.comparisonToNorm.averageValue)}%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p className="hero-comparison-explanation">{heroInsight.comparisonToNorm.explanation}</p>
                  </div>
                )}
                
                <div className="hero-aliza-message">
                  <div className="hero-aliza-header">
                    <div className="hero-aliza-avatar">
                      <img src="/aliza_profile.jpg" alt="×¢×œ×™×–×”" />
                    </div>
                    <span className="hero-aliza-name">×¢×œ×™×–×” ××•××¨×ª:</span>
                  </div>
                  <p className="hero-aliza-text">{heroInsight.alizaMessage}</p>
                </div>
              </div>
            </div>
            
            {heroInsight.actionable && (
              <div className="hero-actionable">
                <span className="hero-actionable-icon">ğŸ’¡</span>
                <span>×™×© ×œ×š ×¤×¢×•×œ×•×ª ××¢×©×™×•×ª ×©×ª×•×›×œ×™ ×œ×‘×¦×¢ - ×œ×—×¦×™ ×œ×¤×¨×˜×™×</span>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Charts Section */}
      <InsightsCharts 
        dailyEntries={dailyEntries}
        cycleEntries={cycleEntries}
        timeRange={timeRange}
        onTimeRangeChange={setTimeRange}
      />

      {/* Insights Grid */}
      <div className="insights-section">
        <div className="section-header">
          <h3>ğŸ’¡ ×”×ª×•×‘× ×•×ª ×©×œ×™ ×¢×‘×•×¨×š</h3>
          <p>× ×™×ª×•×— ××™×©×™ ×©×œ ×”× ×ª×•× ×™× ×©×œ×š</p>
        </div>

        <div className="insights-grid">
          {insights.length === 0 && !heroInsight ? (
            <div className="no-insights-state">
              <div className="no-insights-icon">ğŸ’¡</div>
              <h4>×¢×“×™×™×Ÿ ××™×Ÿ ×ª×•×‘× ×•×ª</h4>
              <p>
                {!hasData 
                  ? '×›×©×ª×ª×—×™×œ×™ ×œ×”×–×™×Ÿ ×¨×©×•××•×ª ×™×•××Ÿ ×•××¢×§×‘ ××—×–×•×¨, ×¢×œ×™×–×” ×ª×•×›×œ ×œ× ×ª×— ××ª ×”× ×ª×•× ×™× ×©×œ×š ×•×œ×¡×¤×§ ×ª×•×‘× ×•×ª ××™×©×™×•×ª.'
                  : '×¢×œ×™×–×” ××¢×‘×“×ª ××ª ×”× ×ª×•× ×™× ×©×œ×š. ×ª×•×‘× ×•×ª ×—×“×©×•×ª ×™×•×¤×™×¢×• ×›××Ÿ ×‘×§×¨×•×‘.'}
              </p>
              {hasData && (
                <div className="generate-insights-action">
                  <button 
                    className="generate-insights-button"
                    onClick={async () => {
                      setIsLoading(true);
                      try {
                        console.log('ğŸ”„ Generating insights manually...');
                        // Call API to generate and save insights
                        const response = await fetch('/api/generate-insights-now', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({ userId }),
                        });

                        if (!response.ok) {
                          const errorData = await response.json();
                          console.error('âŒ API error:', errorData);
                          throw new Error(errorData.error || 'Failed to generate insights');
                        }

                        const result = await response.json();
                        console.log('âœ… Insights generated:', result);

                        // Update tokens in real-time if tokens were deducted
                        if (result.deduct_tokens && result.deduct_tokens > 0) {
                          console.log('ğŸ”„ Updating tokens after insights generation:', result.deduct_tokens);
                          // Wait a bit for database to update
                          await new Promise(resolve => setTimeout(resolve, 300));
                          // Reload tokens to get the updated value from database
                          await loadTokens();
                        }

                        // Wait a bit to ensure data is saved to database
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Reload insights from database
                        console.log('ğŸ”„ Reloading insights from database...');
                        await loadInsights();
                        console.log('âœ… Insights reloaded');
                      } catch (error) {
                        console.error('âŒ Error generating insights:', error);
                        alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×•×‘× ×•×ª. × ×¡×™ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
                      } finally {
                        setIsLoading(false);
                      }
                    }}
                    disabled={isLoading}
                  >
                    {isLoading ? '×™×•×¦×¨ ×ª×•×‘× ×•×ª...' : '×™×¦×™×¨×ª ×ª×•×‘× ×•×ª ×¢×›×©×™×•'}
                  </button>
                  <p className="generate-hint">
                    ×”×ª×•×‘× ×•×ª × ×•×¦×¨×•×ª ××•×˜×•××˜×™×ª ×¤×¢× ×‘×™×•× ×‘×‘×•×§×¨. ×œ×—×™×¦×” ×›××Ÿ ×ª×™×¦×•×¨ ×ª×•×‘× ×•×ª ×—×“×©×•×ª ×¢×›×©×™×• ×¢×œ ×‘×¡×™×¡ ×›×œ ×”× ×ª×•× ×™× ×©×œ×š.
                  </p>
                </div>
              )}
            </div>
          ) : (
            // ×”×¦×’ ××ª ×›×œ ×”×ª×•×‘× ×•×ª, ××¡×•×“×¨×•×ª ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×•×ª ×‘×™×•×ª×¨ ×§×•×“×)
            insights
              .sort((a, b) => {
                // ××¦× ××ª ×”×ª××¨×™×š ×©×œ ×›×œ ×ª×•×‘× ×” ××”× ×ª×•× ×™× ×”××§×•×¨×™×™×
                const aDate = insightsRawData.find((db: any) => db.insight_id === a.id)?.created_at || '';
                const bDate = insightsRawData.find((db: any) => db.insight_id === b.id)?.created_at || '';
                return bDate.localeCompare(aDate); // Newest first
              })
              .map((insight) => {
                // ××¦× ××ª ×”×ª××¨×™×š ×”×××™×ª×™ ×©×œ ×”×ª×•×‘× ×” ××”× ×ª×•× ×™× ×”××§×•×¨×™×™×
                const rawInsight = insightsRawData.find((db: any) => db.insight_id === insight.id);
                const insightDate = rawInsight?.analysis_date || rawInsight?.created_at || new Date().toISOString().split('T')[0];
                
                return (
              <div 
                key={insight.id} 
                className={`insight-card ${insight.priority}`}
                onClick={() => setSelectedInsight(insight)}
              >
                <div className="insight-header">
                  <div className="insight-icons">
                    <span className="category-icon">{getCategoryIcon(insight.category)}</span>
                    <span className="type-icon">{getTypeIcon(insight.type)}</span>
                  </div>
                  <div className="insight-priority" style={{ backgroundColor: getPriorityColor(insight.priority) }}>
                    {insight.priority === 'high' ? '×’×‘×•×”×”' : insight.priority === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}
                  </div>
                </div>
                
                <div className="insight-content">
                  <h4 className="insight-title">{insight.title}</h4>
                  <p className="insight-description">{insight.content}</p>
                  
                  {insight.actionable && (
                    <div className="actionable-badge">
                      <span>ğŸ’¡ × ×™×ª×Ÿ ×œ×¤×¢×•×œ×”</span>
                    </div>
                  )}
                </div>

                <div className="insight-footer">
                  <span className="insight-category">{insight.category}</span>
                  <span className="insight-date">
                    {new Date(insightDate).toLocaleDateString('he-IL')}
                  </span>
                </div>
              </div>
            );
            })
          )}
        </div>
      </div>

      {/* Aliza's Messages Section */}
      <div className="aliza-messages-section">
        <AlizaMessages 
          userId={userId}
          dailyEntries={dailyEntries}
          cycleEntries={cycleEntries}
        />
      </div>

      {/* Insight Detail Modal */}
      {selectedInsight && (
        <div className="insight-modal-overlay" onClick={() => setSelectedInsight(null)}>
          <div className="insight-modal-container" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>{selectedInsight.title}</h3>
              <button 
                className="close-button"
                onClick={() => setSelectedInsight(null)}
              >
                âœ•
              </button>
            </div>
            
            <div className="insight-modal-content">
              <div className="modal-content">
                <div className="insight-details">
                  <div className="detail-row">
                    <span className="detail-label">×§×˜×’×•×¨×™×”:</span>
                    <span className="detail-value">{selectedInsight.category}</span>
                  </div>
                  <div className="detail-row">
                    <span className="detail-label">×¢×“×™×¤×•×ª:</span>
                    <span className="detail-value" style={{ color: getPriorityColor(selectedInsight.priority) }}>
                      {selectedInsight.priority === 'high' ? '×’×‘×•×”×”' : selectedInsight.priority === 'medium' ? '×‘×™× ×•× ×™×ª' : '× ××•×›×”'}
                    </span>
                  </div>
                  <div className="detail-row">
                    <span className="detail-label">×¡×•×’:</span>
                    <span className="detail-value">{selectedInsight.type}</span>
                  </div>
                </div>

              {/* ×”×©×•×•××” ×œ× ×•×¨××” */}
              {selectedInsight.comparisonToNorm && (
                <div className="comparison-section">
                  <h4>ğŸ“Š ×”×©×•×•××” ×œ× ×•×¨××”</h4>
                  <div className="comparison-content">
                    <div className="comparison-bar">
                      <div className="comparison-label">
                        <span>{userName}:</span>
                        <span className="comparison-value">{Math.round(selectedInsight.comparisonToNorm.userValue)}%</span>
                      </div>
                      <div className="comparison-bar-container">
                        <div 
                          className="comparison-bar-fill user-bar"
                          style={{ width: `${Math.min(selectedInsight.comparisonToNorm.userValue, 100)}%` }}
                        />
                      </div>
                    </div>
                    <div className="comparison-bar">
                      <div className="comparison-label">
                        <span>×××•×¦×¢:</span>
                        <span className="comparison-value">{Math.round(selectedInsight.comparisonToNorm.averageValue)}%</span>
                      </div>
                      <div className="comparison-bar-container">
                        <div 
                          className="comparison-bar-fill average-bar"
                          style={{ width: `${Math.min(selectedInsight.comparisonToNorm.averageValue, 100)}%` }}
                        />
                      </div>
                    </div>
                    <p className="comparison-explanation">{selectedInsight.comparisonToNorm.explanation}</p>
                  </div>
                </div>
              )}

              <div className="insight-description-full">
                <h4>×ª×™××•×¨ ××¤×•×¨×˜:</h4>
                <p>{selectedInsight.content}</p>
              </div>

              {/* ×’×¨×£ ×•×™×–×•××œ×™ */}
              {selectedInsight.visualData && (
                <div className="visual-data-section">
                  <h4>ğŸ“ˆ ×”××—×©×” ×’×¨×¤×™×ª</h4>
                  <div className="simple-chart-container">
                    <SimpleChart 
                      data={selectedInsight.visualData.data}
                      type={selectedInsight.visualData.chartType}
                      color={getPriorityColor(selectedInsight.priority)}
                    />
                  </div>
                </div>
              )}

              <div className="aliza-message-detail">
                <div className="message-header">
                  <h4>×¢×œ×™×–×” ××•××¨×ª:</h4>
                  <div className="aliza-avatar-small">
                    <img src="/aliza_profile.jpg" alt="×¢×œ×™×–×”" />
                  </div>
                </div>
                <p>{selectedInsight.alizaMessage}</p>
              </div>

              {selectedInsight.actionable && selectedInsight.actionableSteps && (
                <div className="actionable-section">
                  {selectedInsight.actionableSteps.reliefMethods && selectedInsight.actionableSteps.reliefMethods.length > 0 && (
                    <div className="actionable-subsection">
                      <h4>
                        <span>ğŸ’¡</span>
                        <span>×“×¨×›×™× ×œ×”×§×œ ×¢×œ ×”×ª×¡××™× ×™×:</span>
                      </h4>
                      <ul>
                        {selectedInsight.actionableSteps.reliefMethods.map((method, index) => (
                          <li key={index}>{method}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {selectedInsight.actionableSteps.whoToContact && selectedInsight.actionableSteps.whoToContact.length > 0 && (
                    <div className="actionable-subsection">
                      <h4>
                        <span>ğŸ‘©â€âš•ï¸</span>
                        <span>×œ××™ ×›×“××™ ×œ×¤× ×•×ª:</span>
                      </h4>
                      <ul>
                        {selectedInsight.actionableSteps.whoToContact.map((contact, index) => (
                          <li key={index}>{contact}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {selectedInsight.actionableSteps.questionsToAsk && selectedInsight.actionableSteps.questionsToAsk.length > 0 && (
                    <div className="actionable-subsection">
                      <h4>
                        <span>â“</span>
                        <span>×©××œ×•×ª ×—×©×•×‘×•×ª ×œ×©××•×œ:</span>
                      </h4>
                      <ul>
                        {selectedInsight.actionableSteps.questionsToAsk.map((question, index) => (
                          <li key={index}>{question}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {selectedInsight.actionableSteps.lifestyleChanges && selectedInsight.actionableSteps.lifestyleChanges.length > 0 && (
                    <div className="actionable-subsection">
                      <h4>
                        <span>ğŸ”„</span>
                        <span>×©×™× ×•×™×™× ×‘××•×¨×— ×”×—×™×™×:</span>
                      </h4>
                      <ul>
                        {selectedInsight.actionableSteps.lifestyleChanges.map((change, index) => (
                          <li key={index}>{change}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Simple chart component for insight modal
function SimpleChart({ data, type, color }: { data: any, type: string, color: string }) {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    if (!canvasRef.current || !data?.labels || !data?.datasets) return;
    
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const padding = 60;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw axes
    ctx.strokeStyle = '#dee2e6';
    ctx.lineWidth = 1;
    
    // Y axis
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();

    // X axis
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();

    // Draw data
    const dataset = data.datasets[0];
    if (!dataset || !dataset.data || dataset.data.length === 0) return;

    if (type === 'line') {
      const maxValue = Math.max(...dataset.data);
      const minValue = Math.min(...dataset.data);
      const valueRange = maxValue - minValue || 1;

      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.beginPath();

      dataset.data.forEach((value: number, index: number) => {
        const x = padding + (index / (dataset.data.length - 1)) * chartWidth;
        const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      // Draw points
      ctx.fillStyle = color;
      dataset.data.forEach((value: number, index: number) => {
        const x = padding + (index / (dataset.data.length - 1)) * chartWidth;
        const y = padding + chartHeight - ((value - minValue) / valueRange) * chartHeight;
        
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    // Labels
    ctx.fillStyle = '#6c757d';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    data.labels.forEach((label: string, index: number) => {
      const x = padding + (index / (data.labels.length - 1)) * chartWidth;
      const y = canvas.height - padding + 20;
      ctx.fillText(label, x, y);
    });
  }, [data, type, color]);

  return (
    <canvas 
      ref={canvasRef} 
      width={600} 
      height={300}
      className="simple-chart-canvas"
    />
  );
}
